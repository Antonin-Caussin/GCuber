% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculations.R
\name{calculate_prediction_interval}
\alias{calculate_prediction_interval}
\title{Calculate Relative Prediction Intervals for Tree Volume Estimates}
\usage{
calculate_prediction_interval(
  x,
  equations,
  volume_type,
  equation_id = 1,
  confidence_level = 0.95,
  source = NULL,
  summarize = TRUE
)
}
\arguments{
\item{x}{A \code{data.frame} containing individual tree measurements. Must contain:
\itemize{
  \item \code{Volume} column with predicted values,
  \item \code{Species} column matching the \code{equations} table.
  \item All predictor variables used in the equations (e.g., \code{D130}, \code{HTOT}, etc.).
}}

\item{equations}{A \code{data.frame} of allometric model parameters, including:
\itemize{
  \item Columns: \code{Y}, \code{Species}, \code{Source_Eq}, \code{sigma}, \code{n},
  \code{x_mean_*}, \code{SCE_*}, \code{COV_*}, and predictors \code{X1} to \code{X5}.
}}

\item{volume_type}{Character. The type of volume estimate to use (e.g., \code{"V22"}).}

\item{equation_id}{Integer. Index of the equation to use (default = 1).}

\item{confidence_level}{Numeric. Confidence level for the interval (default = 0.95).}

\item{source}{Character. Optional source filter for selecting equations (e.g., \code{"Dagnelie"}).}

\item{summarize}{Logical. If \code{TRUE}, prints summary statistics globally and per species.}
}
\value{
A \code{data.frame}, same as input \code{x}, with additional columns:
\describe{
  \item{\code{Relative_Width}}{Numeric vector of relative interval widths.}
  \item{\code{Reliability}}{Character vector of qualitative interval interpretations.}
}
}
\description{
Computes the relative width of prediction intervals for tree volume estimates based on
species-specific allometric equations and their associated uncertainty. The function supports
univariate and multivariate models, using provided statistical parameters such as residual
standard error (`sigma`), number of observations (`n`), variance estimates (`SCE_*`),
and covariances (`COV_*`).

The function adds two new columns to the input dataset:
\itemize{
  \item \code{Relative_Width} - The width of the prediction interval divided by the predicted volume.
  \item \code{Reliability} - A qualitative interpretation of the interval's reliability.
}
Optionally, it prints summary statistics globally and by species.
}
\details{
For each individual tree, the prediction interval is calculated using:

\deqn{
\text{Variance} = \sigma^2 \left(1 + \frac{1}{n} + \frac{(x - \bar{x})^2}{SCE} \right)
}

for univariate models, and using the covariance matrix for multivariate models.

The final relative width is computed as:

\deqn{
\text{Relative Width} = \frac{2 \cdot t_{\alpha/2} \cdot \sqrt{\text{Variance}}}{\hat{Y}}
}

Where:
\itemize{
  \item \eqn{t_{\alpha/2}} is the Student's t quantile at the desired confidence level.
  \item \eqn{\hat{Y}} is the predicted volume for the individual.
}

Interpretation is based on thresholds:
\itemize{
  \item < 0.10 -> "Very narrow -> Very reliable"
  \item <= 0.25 -> "Acceptable -> Rather reliable"
  \item <= 0.50 -> "Wide -> Uncertain"
  \item > 0.50 -> "Very wide -> Risky"
  \item NA -> "No calculation"
}
}
\section{Printed Summary (optional)}{

If \code{summarize = TRUE}, the function prints:
\itemize{
  \item Global statistics: count, mean, median, min, max, standard deviation.
  \item Interval interpretation frequency table.
  \item Summary by species (count, mean, median, SD).
  \item Percentiles: P5, P10, P25, P75, P90, P95.
}
}

\examples{
# --- Minimal input data with a proper volume column -----------------------
# NOTE: The function expects either a column named exactly volume_type
#       or "volume_type [m^3]". Here we create "V22 [m^3]".
trees <- data.frame(
  Species   = c("Hetre", "Chene pedoncule", "Epicea commun"),
  D130      = c(32, 40, 28),  # Diameter at 1.30 m [cm]
  HTOT      = c(25, 30, 22)   # Total height [m]
)

# Simple stand-in to get a total stem volume column for the example:
# (You normally obtain this from calculate_volume().)
trees[["V22 [m^3]"]] <- round(0.0001 * trees$D130^2 * trees$HTOT, 3)

# --- Equations table for prediction intervals ----------------------------
# The function filters with Y == volume_type (here "V22").
# Univariate example with X1 = "D130":
#  - required columns: sigma, n, x_mean_D130, SCE_D130
equations <- data.frame(
  Species       = c("Hetre", "Chene pedoncule", "Epicea commun"),
  Y             = rep("V22", 3),
  A0            = NA_real_,
  X1            = rep("D130", 3),
  X2            = NA, X3 = NA, X4 = NA, X5 = NA,
  b0            = NA_real_, b1 = NA_real_, b2 = NA_real_, b3 = NA_real_, b4 = NA_real_, b5 = NA_real_,
  sigma         = c(0.045, 0.050, 0.040),  # residual std. error
  n             = c(120, 140, 110),        # sample size
  x_mean_D130   = c(34, 38, 30),
  SCE_D130      = c(9800, 11500, 8700),    # sum of squares about the mean for D130
  Source_Eq     = rep("Dagnelie", 3),
  check.names   = FALSE
)

# --- Run prediction interval width computation ---------------------------
out <- calculate_prediction_interval(
  x                = trees,
  equations        = equations,
  volume_type      = "V22",
  equation_id      = 1,
  confidence_level = 0.95,
  source           = "Dagnelie",
  summarize        = TRUE
)

print(out)

# --- Random sample: 10 trees per species ----------------------------------
set.seed(123)  # for reproducibility
species <- c("Hetre", "Chene pedoncule", "Epicea commun")
n_rep   <- 10

trees2 <- do.call(rbind, lapply(species, function(sp) data.frame(
  Species = sp,
  D130    = round(runif(n_rep, 20, 60), 1),  # cm
  HTOT    = round(runif(n_rep, 15, 35), 1)   # m
)))

# Create the expected volume column name exactly: "V22 [m^3]"
# (proxy formula with mild random noise)
trees2[["V22 [m^3]"]] <- round(
  0.0001 * trees2$D130^2 * trees2$HTOT * runif(nrow(trees2), 0.9, 1.1),
  3
)

# --- Univariate equations (X1 = "D130") for prediction intervals ----------
equations <- data.frame(
  Species       = species,
  Y             = rep("V22", 3),
  A0            = NA_real_,
  X1            = rep("D130", 3),
  X2 = NA, X3 = NA, X4 = NA, X5 = NA,
  b0 = NA_real_, b1 = NA_real_, b2 = NA_real_, b3 = NA_real_, b4 = NA_real_, b5 = NA_real_,
  sigma         = c(0.045, 0.050, 0.040),
  n             = c(120, 140, 110),
  x_mean_D130   = c(34, 38, 30),
  SCE_D130      = c(9800, 11500, 8700),
  Source_Eq     = rep("Dagnelie", 3),
  check.names   = FALSE
)

# --- Run on the random dataset --------------------------------------------
out2 <- calculate_prediction_interval(
  x                = trees2,
  equations        = equations,
  volume_type      = "V22",
  equation_id      = 1,
  confidence_level = 0.95,
  source           = "Dagnelie",
  summarize        = TRUE
)

head(out2)
attr(out2, "pi_summary")

}
\seealso{
\code{\link{carbofor}}, \code{\link{calculate_volume}}, \code{\link{calculate_biomass}}
}
\author{
Antonin Caussin
}
